<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta content="minimum-scale=1.0, width=device-width, maximum-scale=1, user-scalable=no, viewport-fit=cover"
        name="viewport"/>
  <script src='https://code.jquery.com/jquery-2.2.4.min.js'></script>
  <link href="https://fonts.googleapis.com/css?family=Nanum+Gothic:400,700,800|Noto+Sans+KR:400,500,700|Roboto:400,500,700&display=swap&subset=korean" rel="stylesheet">
  <title>Title</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="./lib/letsee-0.9.20.js"></script>

  <style type="text/css" media="place">
    #container {
      -letsee-target: uri('korloy-product.json');
      -letsee-transform: translate(0, 0, 0);
      width: 100px;
      height: 300px;
    }
  </style>
</head>
<body>

<div id="container">
</div>
<div id="buttonContainer">
  <button id="startButton">스캐닝 시작</button>
</div>

<!-- 하단 푸터 네비게이터 -->
<!-- 1.비디오보기, 2.pdf파일 열기 3.정품인증 4.공구계산기 -->
<div id="bottomNav">
  <button class="bottomNavButton" onclick="location.href='https://player.vimeo.com/external/398187333.sd.mp4?s=167e864af8cfc3a8ba64ac682bef66353314e751&profile_id=164'">
    <img class="bottomNavButtonImage" src="assets/ico-video@3x.png"/>
    <h4 class="bottomNavButtonText">Video<br/>Manual</h4>
  </button>
  <button class="bottomNavButton" onclick="location.href='https://drive.google.com/file/d/1YeiJOokclN0WyuRB8xkRk_kTFjRj1uBA/view?usp=sharing'">
    <img class="bottomNavButtonImage" src="assets/ico-pdf@3x.png"/>
    <h4 class="bottomNavButtonText">Product<br/>Guide</h4>
  </button>
  <button class="bottomNavButton">
    <img class="bottomNavButtonImage" onclick="barCodeGuideStackChange(100)" src="assets/ico-certi@3x.png"/>
    <h4 class="bottomNavButtonText">Genuine<br/>Check</h4>
  </button>
  <button class="bottomNavButton" onclick="location.href='http://kts.korloy.com/app/kts/index.html#/kts/calc'" >
    <img class="bottomNavButtonImage" src="assets/ico-calculator@3x.png"/>
    <h4 class="bottomNavButtonText">KTS<br/>
      <h4 style="visibility: hidden">dummy</h4>
    </h4>
  </button>
</div>

<!-- 정품인증 Barcode 가이드 화면 -->
<div id="barcodeGuide" style="display: none">
  <img id="barcodeGuideImage" src="assets/text-guide@3x.png"/>
  <div id="barcodeGuideInnerBox"></div>
  <button id="barcodeGuideCancelButton" onclick="barCodeGuideStackChange(-1)">Cancel</button>
</div>

<!-- 정품인증 모달 화면 -->
<div id="modal" style="display: none">
  <div id="modalHeader" onclick="modalScreenChange(-1)">
    <h1>Genuine Product<br/>Certification</h1>
    <img src="assets/close-btn@3x.png"/>
  </div>
  <div id="modalBody">
    <div id="modalGenuineInput">
      <div class="modalGenuineInputItem">
        <div class="modalGenuineInputItemText"><h1>KP-CODE</h1></div>
        <input id="modalGenuineInputKpCode" type="text" value="bbb" disabled/>
      </div>
      <div class="modalGenuineInputItem">
        <div class="modalGenuineInputItemText"><h1>LOT No.</h1></div>
        <input id="modalGenuineInputLotNumber" type="text" disabled/>
      </div>
      <div class="modalGenuineInputItem">
        <div class="modalGenuineInputItemText"><h1>SERIAL No.</h1></div>
        <input id="modalGenuineInputSerialNumber" type="text" disabled/>
      </div>
      <div class="modalGenuineInputItem">
        <div class="modalGenuineInputItemText"><h1>GPN</h1></div>
        <input id="modalGenuineInputGpn" type="text"/>
      </div>
    </div>
    <div id="modalGenuineConfirm" style="display: none">
      <div id="modalGenuineConfirmInfo">
        <h1>KP-CODE : <font id="modalGenuineConfirmKpCode">000000000WWW</font></h1>
        <h1>LOT No. : <font id="modalGenuineConfirmLotNumber">DKDKDK</font></h1>
        <h1>SERIAL NO. : <font id="modalGenuineConfirmSerialNumber">KDKDKD</font></h1>
        <h1>GPN : <font id="modalGenuineConfirmGpn">AJAJAJ</font></h1>
      </div>
      <div id="modalGenuineConfirmResult"><h1>This Product is not genuine.</h1></div>
  </div>
  </div>
  <div id="modalFooter">
    <button onclick="modalScreenChange(-1)">Cancel</button>
    <button onclick="modalScreenChange(1)">OK</button>
  </div>
</div>


<script>
  const config = {
    // appKey: '417e8094b7ba9bf9632d8cc5aa94b57fd65582d2d3d2112233e0a727d0d59d05',
    trackerType: 'IMAGE',
    bodyId: 'fallback-test',
    external: "THREE",
  };
  window.addEventListener('load', function () {
    startLetsee();
  });
</script>

<!-- 서드파티 라이브러리 -->
<script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/105/three.min.js"></script>
<script src="vendor/inflate.min.js"></script>
<script src="vendor/loaders/STLLoader.js"></script>

<script>
  /**
   * 렛시 start 프로세스
   * 1. 렛시를 초기화함.
   * 2. 현재 video태그에 id가 없기 때문에 barcodeReader에서 인식할 수 있도록 id태그를 입력하여줌.
   * 3. 후면카메라의 deviceId를 barcodeReader로 넘겨준다.
   * 4. 후면카메라가 없을경우 예외처리. (테스트용도)
   */
  function startLetsee() {
    letsee.init(config, () => {
      console.log('Loaded 됨!');
      // letsee.setVideoSource('b805681e340a7dcbb9688c5b81e960cca210ed3fbfebe7212971f1ad491183ca');
      // 로지텍 디바이스
      letsee.setVideoSource('14e1a19de88888d08a338d1130985a562c4664d9f60c94278b51ff5147bdf87b');
      document.getElementsByTagName('video')[0].setAttribute('id','video');

      // let environmentDeviceId = letsee.getSourceDeviceList()
      //         .find((result) => result.deviceId = "2e6ca0c75165e874e07379aa0135986cd6eed12e1341942cadd6b8f76aa034eb")

      initialBarcodeReader();
      initial3DModel();
    });
  }

  // 초기 바코드 Reader init
  function initialBarcodeReader(deviceId) {
    let selectedDeviceId;
    const codeReader = new ZXing.BrowserMultiFormatReader();
    console.log('ZXing code reader 초기화 성공~');
    codeReader.getVideoInputDevices()
      .then((videoInputDevices) => {
        console.log(videoInputDevices);
        /**
         * 해당 부분에서 비디오 input 디바이스 목록을 얻어옴.
         */
        // selectedDeviceId = videoInputDevices[1].deviceId;
        // letsee.setVideoSource('environment');
        // selectedDeviceId = 'b6c53146faaa5bf52efaad3b80821652c6c41ed2f4569e9ff1346018176d5bb3';
        console.log(selectedDeviceId);
        // const sourceSelect = document.getElementById('sourceSelect');
        // if (videoInputDevices.length >= 1) {
        //   videoInputDevices.forEach((element) => {
        //     const sourceOption = document.createElement('option');
        //     sourceOption.text = element.label;
        //     sourceOption.value = element.deviceId;
        //     sourceSelect.appendChild(sourceOption)
        //   });
        //
        //   sourceSelect.onchange = () => {
        //     selectedDeviceId = sourceSelect.value;
        //   };
        //
        //   const sourceSelectPanel = document.getElementById('sourceSelectPanel')
        //   sourceSelectPanel.style.display = 'block'
        // }
        document.getElementById('startButton').addEventListener('click', () => {
          codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
            if (result) {
              detected2DMatrixCallback(result);
              console.log(result);
            }
            if (err && !(err instanceof ZXing.NotFoundException)) {
              console.error(err);
              // document.getElementById('result').textContent = err
            }
          });
          console.log(`Started continous decode from camera with id ${selectedDeviceId}`)
        });

        // document.getElementById('resetButton').addEventListener('click', () => {
        //   codeReader.reset();
        //   document.getElementById('result').textContent = '';
        //   console.log('Reset.')
        // })

      })
      .catch((err) => {
        console.error(err)
      })
  }

  // ----------- Dom, 화면 관련 메서드 ------------- //
  let barCodeGuideStack = 0;
  function barCodeGuideStackChange(screenStack) {
    let BARCODE_GUIDE = $("#barcodeGuide");
    switch (screenStack) {
      case -1:
        barCodeGuideStack = -1;
        BARCODE_GUIDE.hide();
        break;
      case 100:
        barCodeGuideStack = 100;
        BARCODE_GUIDE.show();
        break;
    }
  }

  let modalBodyStack = 0;
  let kpCode = 'test', lotNumber, serialNumber, gpn;
  function modalScreenChange(modalBodyStack) {
    let MODAL = $("#modal");
    let MODAL_INPUT_SCREEN = $("#modalGenuineInput");
    let MODAL_INPUT_KP_CODE = $("#modalGenuineInputKpCode");
    let MODAL_INPUT_LOT_NUMBER = $("#modalGenuineInputLotNumber");
    let MODAL_INPUT_SERIAL_NUMBER = $("#modalGenuineInputSerialNumber");
    let MODAL_INPUT_GPN = $("#modalGenuineInputGpn");

    let MODAL_CONFIRM_SCREEN = $("#modalGenuineConfirm");
    let MODAL_CONFIRM_KP_CODE = $("#modalGenuineConfirmKpCode");
    let MODAL_CONFIRM_LOT_NUMBER = $("#modalGenuineConfirmLotNumber");
    let MODAL_CONFIRM_SERIAL_NUMBER = $("#modalGenuineConfirmSerialNumber");
    let MODAL_CONFIRM_GPN = $("#modalGenuineConfirmGpn");

    switch (modalBodyStack) {
      case 0:
        MODAL_INPUT_KP_CODE.val(kpCode);
        MODAL_INPUT_LOT_NUMBER.val(lotNumber);
        MODAL_INPUT_SERIAL_NUMBER.val(serialNumber);
        MODAL_INPUT_SCREEN.show();
        MODAL_CONFIRM_SCREEN.hide();
        break;
      case 1:
        // TODO : 정품인증을 하는 API를 태운 후 화면을 바꿔줘야함.
        MODAL_INPUT_SCREEN.hide();
        MODAL_CONFIRM_KP_CODE.text(kpCode);
        MODAL_CONFIRM_LOT_NUMBER.text(lotNumber);
        MODAL_CONFIRM_SERIAL_NUMBER.text(serialNumber);
        MODAL_CONFIRM_GPN.text(MODAL_INPUT_GPN.val());
        MODAL_CONFIRM_SCREEN.show();
        break;

      case -1: // modal close
        MODAL_INPUT_GPN.val("");
        MODAL.hide();
        break;
      case 100: // modal open
        modalScreenChange(0);
        MODAL.show();
        break;
    }
  }

  // ----------- 기능 구현 ---------- //
  /**
   * 데이터 Matrix로부터 넘어온 String을 파싱함.
   * 데이터 형식 : "1-02-037151000143326900550010A000118H31"
   * 품번(KP-CODE) => 처음 11개 : 1번째부터 11번째 숫자.
   * Lot번호 => 이후 10개 => 12번째부터 21번째 숫자.
   * Serial번호 => 이후 4개 => 22번째부터 25번째 숫자.
   */
  function parseProductNumberFromString(str) {
    let _kpCode = str.substr(0, 11);
    str = str.substr(11);
    let _lotNumber = str.substr(0, 10);
    str = str.substr(10);
    let _serialNumber = str.substr(0, 4);
    str = str.substr(4);
    console.log(_kpCode, _lotNumber, _serialNumber);
    return {_kpCode, _lotNumber, _serialNumber};
  }

  /**
   * zxing의 바코드 스캔 이후 동작하는 콜백함수
   * 2d 매트릭스 결과를 kpCode, lotNumber, serialNumber로 파싱핟 뒤 제품인증 모달을 띄워준다.
   */
  function detected2DMatrixCallback (result) {
    if (barCodeGuideStack === 100) {
      let {_kpCode, _lotNumber, _serialNumber} = parseProductNumberFromString(result.text);
      kpCode= _kpCode;
      lotNumber = _lotNumber;
      serialNumber = _serialNumber;

      console.log(kpCode, lotNumber, serialNumber);
      barCodeGuideStackChange(-1);
      modalScreenChange(100);
    }
  }

  // -------------3D 모델 로드 ------------ //
  let world = new THREE.Object3D();
  let scene ;
  function initial3DModel() {
    // Using renderer, camera and scene from Engine.
    const renderer = letsee.threeRenderer;
    const camera = renderer.camera;
    scene = renderer.scene;
    renderer.addObjectToEntity('korloy-product.json', world);
    scene.add( new THREE.HemisphereLight( 0x000000, 0xffffff ) );
    var loader = new THREE.STLLoader();
    loader.load( './models/stl/korloy.stl', function ( geometry ) {
      var material = new THREE.MeshPhongMaterial({
        color: 0xc7c7c2,
        specular: 0x000000,
        shininess: 100,
        emissive: 0x0,
      });
      var mesh = new THREE.Mesh( geometry, material );
      mesh.position.set( 0, 0, 30 );
      mesh.scale.set( 0.5, 0.5, 0.5 );
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      world.add(mesh);
    }, (progress) => {
      console.log(progress);
    }, (error) => {
      console.log(error);
    });
  }
</script>
</body>
</html>
